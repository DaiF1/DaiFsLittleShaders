(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&r(u)}).observe(document,{childList:!0,subtree:!0});function a(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=a(n);fetch(n.href,o)}})();function K(e){const t=e.clientWidth,a=e.clientHeight,r=e.width!==t||e.height!==a;return r&&(e.width=t,e.height=a),r}function te(e,t,a){var r=e.createShader(t);e.shaderSource(r,a),e.compileShader(r);var n=e.getShaderParameter(r,e.COMPILE_STATUS);if(n)return r;var o="vertex";t===e.FRAGMENT_SHADER&&(o="fragment"),console.log(a),console.log(o,e.getShaderInfoLog(r)),e.deleteShader(r)}function se(e,t,a){var r=e.createProgram();e.attachShader(r,t),e.attachShader(r,a),e.linkProgram(r);var n=e.getProgramParameter(r,e.LINK_STATUS);if(n)return r;console.log(e.getProgramInfoLog(r)),e.deleteProgram(r)}var j={},oe={};function ce(e,t){Object.keys(t).forEach(a=>{if(!j[t[a].vertex]){var r=document.querySelector("#"+t[a].vertex).text;j[t[a].vertex]=te(e,e.VERTEX_SHADER,r)}if(!j[t[a].fragment]){var r=document.querySelector("#"+t[a].fragment).text;j[t[a].fragment]=te(e,e.FRAGMENT_SHADER,r)}oe[a]=se(e,j[t[a].vertex],j[t[a].fragment])})}function fe(e,t){e.useProgram(J(t))}function J(e){return oe[e]}var G={};function ue(e,t,a){G[t]||(G[t]={}),Object.keys(a).forEach(r=>{G[t][r]||(G[t][r]=e.getAttribLocation(J(t),r)),G[t][r]!==-1&&(e.bindBuffer(e.ARRAY_BUFFER,a[r].buffer),e.enableVertexAttribArray(G[t][r]),e.vertexAttribPointer(G[t][r],a[r].numComponents,e.FLOAT,!1,0,0))})}var z={};function Y(e,t,a){z[t]||(z[t]={}),fe(e,t),Object.keys(a).forEach(r=>{switch(z[t][r]||(z[t][r]=e.getUniformLocation(J(t),r)),a[r].type){case"int1":e.uniform1i(z[t][r],a[r].data);break;case"float1":e.uniform1f(z[t][r],a[r].data);break;case"vec3":e.uniform3fv(z[t][r],a[r].data);break;case"mat4":e.uniformMatrix4fv(z[t][r],!1,a[r].data);break}})}function ve(e,t){let a;if(e.indexOf("coord")>=0?a=2:e.indexOf("color")>=0?a=4:a=3,t%a>0)throw"can not guess numComponents. You should specify it.";return a}function Ee(e,t){return e.numComponents||e.size||ve(t,ie(e).length)}function ie(e){return e.length?e:e.data}function de(e){let t;const a=["position","positions","a_position"];for(const m of a)if(m in e){t=m;break}t=t||Object.keys(e)[0];const r=e[t],n=ie(r).length,o=Ee(r,t),u=n/o;if(n%o>0)throw new Error(`numComponents ${o} not correct for length ${n}`);return u}function $(e,t){var a={};return a.numElements=de(t),a.attribs={},Object.keys(t).forEach(r=>{a.attribs["a_"+r]={},a.attribs["a_"+r].buffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,a.attribs["a_"+r].buffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(t[r]),e.STATIC_DRAW),a.attribs["a_"+r].numComponents=3}),a.attribs.a_texcoord.numComponents=2,a}function q(e,t,a){ue(e,t,a.attribs)}var c={identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},perspective:function(e,t,a,r){var n=Math.tan(Math.PI*.5-.5*e),o=1/(a-r);return[n/t,0,0,0,0,n,0,0,0,0,(a+r)*o,-1,0,0,a*r*o*2,0]},orthographic:function(e,t,a,r,n,o){return[2/(t-e),0,0,0,0,2/(r-a),0,0,0,0,2/(n-o),0,(e+t)/(e-t),(a+r)/(a-r),(n+o)/(n-o),1]},translation:function(e,t,a){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,a,1]},xRotation:function(e){var t=Math.cos(e),a=Math.sin(e);return[1,0,0,0,0,t,a,0,0,-a,t,0,0,0,0,1]},yRotation:function(e){var t=Math.cos(e),a=Math.sin(e);return[t,0,-a,0,0,1,0,0,a,0,t,0,0,0,0,1]},zRotation:function(e){var t=Math.cos(e),a=Math.sin(e);return[t,a,0,0,-a,t,0,0,0,0,1,0,0,0,0,1]},scaling:function(e,t,a){return[e,0,0,0,0,t,0,0,0,0,a,0,0,0,0,1]},multiply:function(e,t){var a=t[0],r=t[0*4+1],n=t[0*4+2],o=t[0*4+3],u=t[1*4+0],m=t[1*4+1],_=t[1*4+2],v=t[1*4+3],s=t[2*4+0],E=t[2*4+1],f=t[2*4+2],d=t[2*4+3],i=t[3*4+0],T=t[3*4+1],R=t[3*4+2],I=t[3*4+3],L=e[0*4+0],U=e[0*4+1],l=e[0*4+2],A=e[0*4+3],P=e[1*4+0],S=e[1*4+1],C=e[1*4+2],p=e[1*4+3],y=e[2*4+0],D=e[2*4+1],F=e[2*4+2],b=e[2*4+3],N=e[3*4+0],X=e[3*4+1],O=e[3*4+2],B=e[3*4+3];return[a*L+r*P+n*y+o*N,a*U+r*S+n*D+o*X,a*l+r*C+n*F+o*O,a*A+r*p+n*b+o*B,u*L+m*P+_*y+v*N,u*U+m*S+_*D+v*X,u*l+m*C+_*F+v*O,u*A+m*p+_*b+v*B,s*L+E*P+f*y+d*N,s*U+E*S+f*D+d*X,s*l+E*C+f*F+d*O,s*A+E*p+f*b+d*B,i*L+T*P+R*y+I*N,i*U+T*S+R*D+I*X,i*l+T*C+R*F+I*O,i*A+T*p+R*b+I*B]},cross:function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]},subtractVectors:function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},normalize:function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return t>1e-5?[e[0]/t,e[1]/t,e[2]/t]:[0,0,0]},lookAt:function(e,t,a){var r=c.normalize(c.subtractVectors(e,t)),n=c.normalize(c.cross(a,r)),o=c.normalize(c.cross(r,n));return[n[0],n[1],n[2],0,o[0],o[1],o[2],0,r[0],r[1],r[2],0,e[0],e[1],e[2],1]},translate:function(e,t,a,r){return c.multiply(e,c.translation(t,a,r))},xRotate:function(e,t){return c.multiply(e,c.xRotation(t))},yRotate:function(e,t){return c.multiply(e,c.yRotation(t))},zRotate:function(e,t){return c.multiply(e,c.zRotation(t))},scale:function(e,t,a,r){return c.multiply(e,c.scaling(t,a,r))},inverse:function(e){var t=e[0],a=e[0*4+1],r=e[0*4+2],n=e[0*4+3],o=e[1*4+0],u=e[1*4+1],m=e[1*4+2],_=e[1*4+3],v=e[2*4+0],s=e[2*4+1],E=e[2*4+2],f=e[2*4+3],d=e[3*4+0],i=e[3*4+1],T=e[3*4+2],R=e[3*4+3],I=E*R,L=T*f,U=m*R,l=T*_,A=m*f,P=E*_,S=r*R,C=T*n,p=r*f,y=E*n,D=r*_,F=m*n,b=v*i,N=d*s,X=o*i,O=d*u,B=o*s,M=v*u,H=t*i,h=d*a,k=t*s,w=v*a,V=t*u,W=o*a,Q=I*u+l*s+A*i-(L*u+U*s+P*i),Z=L*a+S*s+y*i-(I*a+C*s+p*i),g=U*a+C*u+D*i-(l*a+S*u+F*i),ee=P*a+p*u+F*s-(A*a+y*u+D*s),x=1/(t*Q+o*Z+v*g+d*ee);return[x*Q,x*Z,x*g,x*ee,x*(L*o+U*v+P*d-(I*o+l*v+A*d)),x*(I*t+C*v+p*d-(L*t+S*v+y*d)),x*(l*t+S*o+F*d-(U*t+C*o+D*d)),x*(A*t+y*o+D*v-(P*t+p*o+F*v)),x*(b*_+O*f+B*R-(N*_+X*f+M*R)),x*(N*n+H*f+w*R-(b*n+h*f+k*R)),x*(X*n+h*_+V*R-(O*n+H*_+W*R)),x*(M*n+k*_+W*f-(B*n+w*_+V*f)),x*(X*E+M*T+N*m-(B*T+b*m+O*E)),x*(k*T+b*r+h*E-(H*E+w*T+N*r)),x*(H*m+W*T+O*r-(V*T+X*r+h*m)),x*(V*E+B*r+w*m-(k*m+W*E+M*r))]},transpose:function(e){return[e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]]},vectorMultiply:function(e,t){for(var a=[],r=0;r<4;++r){a[r]=0;for(var n=0;n<4;++n)a[r]+=e[n]*t[n*4+r]}return a}};function re(e){const t=[[0,0,0]],a=[[0,0]],r=[[0,0,0]],n=[t,a,r];let o=[[],[],[]];function u(s){s.split("/").forEach((f,d)=>{if(!f)return;const i=parseInt(f),T=i+(i>=0?0:n[d].length);o[d].push(...n[d][T])})}const m={v(s){t.push(s.map(parseFloat))},vn(s){r.push(s.map(parseFloat))},vt(s){a.push(s.map(parseFloat))},f(s){const E=s.length-2;for(let f=0;f<E;++f)u(s[0]),u(s[f+1]),u(s[f+2])}},_=/(\w*)(?: )*(.*)/,v=e.split(`
`);for(let s=0;s<v.length;++s){const E=v[s].trim();if(E===""||E.startsWith("#"))continue;const f=_.exec(E);if(!f)continue;const[,d,i]=f,T=E.split(/\s+/).slice(1),R=m[d];if(!R){console.warn("unhandled keyword:",d,"at line",s+1);continue}R(T,i)}return{position:o[0],texcoord:o[1],normal:o[2]}}function ae(e,t,a,r){const n=e.createTexture();e.activeTexture(t),e.bindTexture(e.TEXTURE_2D,n);const o=0,u=e.RGBA,m=0,_=e.RGBA,v=e.UNSIGNED_BYTE,s=null;e.texImage2D(e.TEXTURE_2D,o,u,a,r,m,_,v,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const E=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,E),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,a,r);const f=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,f),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,o),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,E);var d={frameBuffer:f,texture:n,width:a,height:r};return d}function ne(e,t,a,r){var n=e.createTexture();e.activeTexture(a),e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,255,255]));var o=new Image;o.src=t,o.addEventListener("load",()=>{e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,o),!(o.width&o.width-1)&&!(o.height&o.height-1)?e.generateMipmap(e.TEXTURE_2D):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r)})}async function me(){var e=document.querySelector("#c"),t=e.getContext("webgl");t||console.log("ERROR: Failed to initialize webgl");var a={depth:{vertex:"vertex-depth",fragment:"fragment-depth"},default:{vertex:"default-vertex",fragment:"default-fragment"},gooch:{vertex:"default-vertex",fragment:"gooch-fragment"},comics:{vertex:"default-vertex",fragment:"comics-fragment"},drawing:{vertex:"default-vertex",fragment:"drawing-fragment"},postp_default:{vertex:"default-vertex-postp",fragment:"default-fragment-postp"},postp_gooch:{vertex:"default-vertex-postp",fragment:"outline-fragment-postp"},postp_comics:{vertex:"default-vertex-postp",fragment:"outline-fragment-postp"},postp_drawing:{vertex:"default-vertex-postp",fragment:"outline-fragment-postp"}};ce(t,a);var r="default",n=document.querySelector("#shader-select");n.addEventListener("change",()=>{r=n.value,o(r)});function o(p){q(t,p,v),Y(t,p,E)}var u=await fetch("resources/tree.obj"),m=await u.text(),_=re(m),v=$(t,_);u=await fetch("resources/ground.obj"),m=await u.text(),_=re(m);var s=$(t,_),E={u_reverseLightDir:{data:c.normalize([.5,.7,-1]),type:"vec3"},u_texture:{data:0,type:"int1"},u_textureHash:{data:3,type:"int1"}},f={u_world:{data:c.identity(),type:"mat4"},u_worldViewMatrix:{data:c.identity(),type:"mat4"},u_cameraView:{data:c.identity(),type:"mat4"},u_time:{data:0,type:"float1"}},d={u_width:{data:t.canvas.clientWidth,type:"float1"},u_height:{data:t.canvas.clientHeight,type:"float1"},u_depthTexture:{data:1,type:"int1"},u_screenTexture:{data:2,type:"int1"}};q(t,r,v),Y(t,r,E);function i(p){return p*Math.PI/180}var T=[{bufferInfo:v,translation:[0,0,-23],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{bufferInfo:v,translation:[0,0,25],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{bufferInfo:v,translation:[10,0,20],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{bufferInfo:v,translation:[-11,0,-22],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{bufferInfo:v,translation:[23,0,0],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{bufferInfo:v,translation:[-22,0,-1],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{bufferInfo:s,translation:[0,-10,0],rotation:[i(0),i(0),i(0)],scale:[2,2,2]}],R=0,I=0,L=.01,U=!1;addEventListener("keydown",p=>{U=p.ctrlKey}),addEventListener("keyup",p=>{U=p.ctrlKey}),addEventListener("mousemove",p=>{U&&(I-=p.movementX*L,R=Math.max(Math.min(R-p.movementY*L,i(60)),i(-50)))}),ne(t,"./resources/palette.png",t.TEXTURE0,t.LINEAR),ne(t,"./resources/hash.png",t.TEXTURE3,t.NEAREST);var l=ae(t,t.TEXTURE1,t.canvas.clientWidth,t.canvas.clientHeight),A=ae(t,t.TEXTURE2,t.canvas.clientWidth,t.canvas.clientHeight);function P(p){var y=i(60),D=1,F=200,b=c.yRotation(I);b=c.xRotate(b,R),b=c.translate(b,0,10,0);var N=c.inverse(b),X=c.perspective(y,p,D,F),O=c.multiply(X,N);for(let w=0;w<T.length;w++){var B=T[w].translation,M=T[w].rotation,H=T[w].scale,h=c.identity();h=c.translate(h,B[0],B[1],B[2]),h=c.xRotate(h,M[0]),h=c.yRotate(h,M[1]),h=c.zRotate(h,M[2]),h=c.scale(h,H[0],H[1],H[2]);var k=c.multiply(O,h);h=c.inverse(h),h=c.transpose(h),f.u_worldViewMatrix.data=k,f.u_world.data=h,f.u_cameraView.data=b,f.u_time.data=S,q(t,r,T[w].bufferInfo),Y(t,r,f),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.drawArrays(t.TRIANGLES,0,T[w].bufferInfo.numElements)}}var S=0;function C(){S+=.03;{t.bindFramebuffer(t.FRAMEBUFFER,l.frameBuffer),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,l.texture);var p=r;r="depth",o(r),K(t.canvas),t.viewport(0,0,l.width,l.height),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST);const F=l.width/l.height;P(F),r=p}{t.bindFramebuffer(t.FRAMEBUFFER,A.frameBuffer),o(r),K(t.canvas),t.viewport(0,0,A.width,A.height),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST);const F=A.width/A.height;P(F)}{t.bindFramebuffer(t.FRAMEBUFFER,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,l.texture),K(t.canvas),t.viewport(0,0,t.canvas.clientWidth,t.canvas.clientHeight),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST);var y={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0],texcoord:[0,0,1,0,0,1,0,1,1,0,1,1]},D=$(t,y);Y(t,"postp_"+r,d),q(t,"postp_"+r,D),t.drawArrays(t.TRIANGLES,0,6)}}C(),setInterval(C,33)}me();
