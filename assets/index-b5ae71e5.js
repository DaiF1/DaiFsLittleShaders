(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const v of o.addedNodes)v.tagName==="LINK"&&v.rel==="modulepreload"&&r(v)}).observe(document,{childList:!0,subtree:!0});function a(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=a(n);fetch(n.href,o)}})();function q(e){const t=e.clientWidth,a=e.clientHeight,r=e.width!==t||e.height!==a;return r&&(e.width=t,e.height=a),r}function ee(e,t,a){var r=e.createShader(t);e.shaderSource(r,a),e.compileShader(r);var n=e.getShaderParameter(r,e.COMPILE_STATUS);if(n)return r;var o="vertex";t===e.FRAGMENT_SHADER&&(o="fragment"),console.log(a),console.log(o,e.getShaderInfoLog(r)),e.deleteShader(r)}function ie(e,t,a){var r=e.createProgram();e.attachShader(r,t),e.attachShader(r,a),e.linkProgram(r);var n=e.getProgramParameter(r,e.LINK_STATUS);if(n)return r;console.log(e.getProgramInfoLog(r)),e.deleteProgram(r)}var k={},ne={};function se(e,t){Object.keys(t).forEach(a=>{if(!k[t[a].vertex]){var r=document.querySelector("#"+t[a].vertex).text;k[t[a].vertex]=ee(e,e.VERTEX_SHADER,r)}if(!k[t[a].fragment]){var r=document.querySelector("#"+t[a].fragment).text;k[t[a].fragment]=ee(e,e.FRAGMENT_SHADER,r)}ne[a]=ie(e,k[t[a].vertex],k[t[a].fragment])})}function ce(e,t){e.useProgram(K(t))}function K(e){return ne[e]}var z={};function ue(e,t,a){z[t]||(z[t]={}),Object.keys(a).forEach(r=>{z[t][r]||(z[t][r]=e.getAttribLocation(K(t),r)),z[t][r]!==-1&&(e.bindBuffer(e.ARRAY_BUFFER,a[r].buffer),e.enableVertexAttribArray(z[t][r]),e.vertexAttribPointer(z[t][r],a[r].numComponents,e.FLOAT,!1,0,0))})}var H={};function Y(e,t,a){H[t]||(H[t]={}),ce(e,t),Object.keys(a).forEach(r=>{switch(H[t][r]||(H[t][r]=e.getUniformLocation(K(t),r)),a[r].type){case"int1":e.uniform1i(H[t][r],a[r].data);break;case"float1":e.uniform1f(H[t][r],a[r].data);break;case"vec3":e.uniform3fv(H[t][r],a[r].data);break;case"mat4":e.uniformMatrix4fv(H[t][r],!1,a[r].data);break}})}function fe(e,t){let a;if(e.indexOf("coord")>=0?a=2:e.indexOf("color")>=0?a=4:a=3,t%a>0)throw"can not guess numComponents. You should specify it.";return a}function ve(e,t){return e.numComponents||e.size||fe(t,oe(e).length)}function oe(e){return e.length?e:e.data}function de(e){let t;const a=["position","positions","a_position"];for(const p of a)if(p in e){t=p;break}t=t||Object.keys(e)[0];const r=e[t],n=oe(r).length,o=ve(r,t),v=n/o;if(n%o>0)throw new Error(`numComponents ${o} not correct for length ${n}`);return v}function te(e,t){var a={};return a.numElements=de(t),a.attribs={},Object.keys(t).forEach(r=>{a.attribs["a_"+r]={},a.attribs["a_"+r].buffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,a.attribs["a_"+r].buffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(t[r]),e.STATIC_DRAW),a.attribs["a_"+r].numComponents=3}),a.attribs.a_texcoord.numComponents=2,a}function g(e,t,a){ue(e,t,a.attribs)}var c={identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},perspective:function(e,t,a,r){var n=Math.tan(Math.PI*.5-.5*e),o=1/(a-r);return[n/t,0,0,0,0,n,0,0,0,0,(a+r)*o,-1,0,0,a*r*o*2,0]},orthographic:function(e,t,a,r,n,o){return[2/(t-e),0,0,0,0,2/(r-a),0,0,0,0,2/(n-o),0,(e+t)/(e-t),(a+r)/(a-r),(n+o)/(n-o),1]},translation:function(e,t,a){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,a,1]},xRotation:function(e){var t=Math.cos(e),a=Math.sin(e);return[1,0,0,0,0,t,a,0,0,-a,t,0,0,0,0,1]},yRotation:function(e){var t=Math.cos(e),a=Math.sin(e);return[t,0,-a,0,0,1,0,0,a,0,t,0,0,0,0,1]},zRotation:function(e){var t=Math.cos(e),a=Math.sin(e);return[t,a,0,0,-a,t,0,0,0,0,1,0,0,0,0,1]},scaling:function(e,t,a){return[e,0,0,0,0,t,0,0,0,0,a,0,0,0,0,1]},multiply:function(e,t){var a=t[0],r=t[0*4+1],n=t[0*4+2],o=t[0*4+3],v=t[1*4+0],p=t[1*4+1],_=t[1*4+2],d=t[1*4+3],s=t[2*4+0],u=t[2*4+1],f=t[2*4+2],i=t[2*4+3],m=t[3*4+0],T=t[3*4+1],h=t[3*4+2],B=t[3*4+3],U=e[0*4+0],l=e[0*4+1],A=e[0*4+2],w=e[0*4+3],I=e[1*4+0],S=e[1*4+1],E=e[1*4+2],y=e[1*4+3],D=e[2*4+0],F=e[2*4+1],x=e[2*4+2],C=e[2*4+3],X=e[3*4+0],O=e[3*4+1],L=e[3*4+2],P=e[3*4+3];return[a*U+r*I+n*D+o*X,a*l+r*S+n*F+o*O,a*A+r*E+n*x+o*L,a*w+r*y+n*C+o*P,v*U+p*I+_*D+d*X,v*l+p*S+_*F+d*O,v*A+p*E+_*x+d*L,v*w+p*y+_*C+d*P,s*U+u*I+f*D+i*X,s*l+u*S+f*F+i*O,s*A+u*E+f*x+i*L,s*w+u*y+f*C+i*P,m*U+T*I+h*D+B*X,m*l+T*S+h*F+B*O,m*A+T*E+h*x+B*L,m*w+T*y+h*C+B*P]},cross:function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]},subtractVectors:function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},normalize:function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return t>1e-5?[e[0]/t,e[1]/t,e[2]/t]:[0,0,0]},lookAt:function(e,t,a){var r=c.normalize(c.subtractVectors(e,t)),n=c.normalize(c.cross(a,r)),o=c.normalize(c.cross(r,n));return[n[0],n[1],n[2],0,o[0],o[1],o[2],0,r[0],r[1],r[2],0,e[0],e[1],e[2],1]},translate:function(e,t,a,r){return c.multiply(e,c.translation(t,a,r))},xRotate:function(e,t){return c.multiply(e,c.xRotation(t))},yRotate:function(e,t){return c.multiply(e,c.yRotation(t))},zRotate:function(e,t){return c.multiply(e,c.zRotation(t))},scale:function(e,t,a,r){return c.multiply(e,c.scaling(t,a,r))},inverse:function(e){var t=e[0],a=e[0*4+1],r=e[0*4+2],n=e[0*4+3],o=e[1*4+0],v=e[1*4+1],p=e[1*4+2],_=e[1*4+3],d=e[2*4+0],s=e[2*4+1],u=e[2*4+2],f=e[2*4+3],i=e[3*4+0],m=e[3*4+1],T=e[3*4+2],h=e[3*4+3],B=u*h,U=T*f,l=p*h,A=T*_,w=p*f,I=u*_,S=r*h,E=T*n,y=r*f,D=u*n,F=r*_,x=p*n,C=d*m,X=i*s,O=o*m,L=i*v,P=o*s,N=d*v,R=t*m,G=i*a,M=t*s,V=d*a,W=t*v,j=o*a,$=B*v+A*s+w*m-(U*v+l*s+I*m),J=U*a+S*s+D*m-(B*a+E*s+y*m),Q=l*a+E*v+F*m-(A*a+S*v+x*m),Z=I*a+y*v+x*s-(w*a+D*v+F*s),b=1/(t*$+o*J+d*Q+i*Z);return[b*$,b*J,b*Q,b*Z,b*(U*o+l*d+I*i-(B*o+A*d+w*i)),b*(B*t+E*d+y*i-(U*t+S*d+D*i)),b*(A*t+S*o+x*i-(l*t+E*o+F*i)),b*(w*t+D*o+F*d-(I*t+y*o+x*d)),b*(C*_+L*f+P*h-(X*_+O*f+N*h)),b*(X*n+R*f+V*h-(C*n+G*f+M*h)),b*(O*n+G*_+W*h-(L*n+R*_+j*h)),b*(N*n+M*_+j*f-(P*n+V*_+W*f)),b*(O*u+N*T+X*p-(P*T+C*p+L*u)),b*(M*T+C*r+G*u-(R*u+V*T+X*r)),b*(R*p+j*T+L*r-(W*T+O*r+G*p)),b*(W*u+P*r+V*p-(M*p+j*u+N*r))]},transpose:function(e){return[e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]]},vectorMultiply:function(e,t){for(var a=[],r=0;r<4;++r){a[r]=0;for(var n=0;n<4;++n)a[r]+=e[n]*t[n*4+r]}return a}};function Ee(e){const t=[[0,0,0]],a=[[0,0]],r=[[0,0,0]],n=[t,a,r];let o=[[],[],[]];function v(s){s.split("/").forEach((f,i)=>{if(!f)return;const m=parseInt(f),T=m+(m>=0?0:n[i].length);o[i].push(...n[i][T])})}const p={v(s){t.push(s.map(parseFloat))},vn(s){r.push(s.map(parseFloat))},vt(s){a.push(s.map(parseFloat))},f(s){const u=s.length-2;for(let f=0;f<u;++f)v(s[0]),v(s[f+1]),v(s[f+2])}},_=/(\w*)(?: )*(.*)/,d=e.split(`
`);for(let s=0;s<d.length;++s){const u=d[s].trim();if(u===""||u.startsWith("#"))continue;const f=_.exec(u);if(!f)continue;const[,i,m]=f,T=u.split(/\s+/).slice(1),h=p[i];if(!h){console.warn("unhandled keyword:",i,"at line",s+1);continue}h(T,m)}return{position:o[0],texcoord:o[1],normal:o[2]}}function re(e,t,a,r){const n=e.createTexture();e.activeTexture(t),e.bindTexture(e.TEXTURE_2D,n);const o=0,v=e.RGBA,p=0,_=e.RGBA,d=e.UNSIGNED_BYTE,s=null;e.texImage2D(e.TEXTURE_2D,o,v,a,r,p,_,d,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const u=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,u);const f=e.COLOR_ATTACHMENT0;e.framebufferTexture2D(e.FRAMEBUFFER,f,e.TEXTURE_2D,n,o);var i={frameBuffer:u,texture:n,width:a,height:r};return i}function ae(e,t,a,r){var n=e.createTexture();e.activeTexture(a),e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,255,255]));var o=new Image;o.src=t,o.addEventListener("load",()=>{e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,o),!(o.width&o.width-1)&&!(o.height&o.height-1)?e.generateMipmap(e.TEXTURE_2D):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r)})}async function me(){var e=document.querySelector("#c"),t=e.getContext("webgl");t||console.log("ERROR: Failed to initialize webgl");var a={depth:{vertex:"vertex-depth",fragment:"fragment-depth"},default:{vertex:"default-vertex",fragment:"default-fragment"},gooch:{vertex:"default-vertex",fragment:"gooch-fragment"},comics:{vertex:"default-vertex",fragment:"comics-fragment"},drawing:{vertex:"default-vertex",fragment:"drawing-fragment"},postp_default:{vertex:"default-vertex-postp",fragment:"default-fragment-postp"},postp_gooch:{vertex:"default-vertex-postp",fragment:"outline-fragment-postp"},postp_comics:{vertex:"default-vertex-postp",fragment:"outline-fragment-postp"},postp_drawing:{vertex:"default-vertex-postp",fragment:"outline-fragment-postp"}};se(t,a);var r="default",n=document.querySelector("#shader-select");n.addEventListener("change",()=>{r=n.value,o(r)});function o(E){g(t,E,d),Y(t,E,s)}var p=await(await fetch("resources/tree.obj")).text();const _=Ee(p);var d=te(t,_),s={u_reverseLightDir:{data:c.normalize([.5,.7,-1]),type:"vec3"},u_texture:{data:0,type:"int1"},u_textureHash:{data:3,type:"int1"}},u={u_world:{data:c.identity(),type:"mat4"},u_worldViewMatrix:{data:c.identity(),type:"mat4"},u_cameraView:{data:c.identity(),type:"mat4"},u_time:{data:0,type:"float1"}},f={u_width:{data:t.canvas.clientWidth,type:"float1"},u_height:{data:t.canvas.clientHeight,type:"float1"},u_depthTexture:{data:1,type:"int1"},u_screenTexture:{data:2,type:"int1"}};g(t,r,d),Y(t,r,s);function i(E){return E*Math.PI/180}var m=[{translation:[0,0,-23],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{translation:[0,0,25],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{translation:[10,0,20],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{translation:[-11,0,-22],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{translation:[23,0,0],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{translation:[-22,0,-1],rotation:[i(0),i(0),i(0)],scale:[2,2,2]}],T=0,h=0,B=.01,U=!1;addEventListener("keydown",E=>{U=E.ctrlKey}),addEventListener("keyup",E=>{U=E.ctrlKey}),addEventListener("mousemove",E=>{U&&(h-=E.movementX*B,T=Math.max(Math.min(T-E.movementY*B,i(60)),i(-50)))}),ae(t,"./resources/palette.png",t.TEXTURE0,t.LINEAR),ae(t,"./resources/hash.png",t.TEXTURE3,t.NEAREST);var l=re(t,t.TEXTURE1,t.canvas.clientWidth,t.canvas.clientHeight),A=re(t,t.TEXTURE2,t.canvas.clientWidth,t.canvas.clientHeight);function w(E){var y=i(60),D=1,F=200,x=c.yRotation(h);x=c.xRotate(x,T),x=c.translate(x,0,10,0);var C=c.inverse(x),X=c.perspective(y,E,D,F),O=c.multiply(X,C);for(let M=0;M<m.length;M++){var L=m[M].translation,P=m[M].rotation,N=m[M].scale,R=c.identity();R=c.translate(R,L[0],L[1],L[2]),R=c.xRotate(R,P[0]),R=c.yRotate(R,P[1]),R=c.zRotate(R,P[2]),R=c.scale(R,N[0],N[1],N[2]);var G=c.multiply(O,R);u.u_worldViewMatrix.data=G,u.u_world.data=R,u.u_cameraView.data=x,u.u_time.data=I,g(t,r,d),Y(t,r,u),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.drawArrays(t.TRIANGLES,0,d.numElements)}}var I=0;function S(){I+=.03;{t.bindFramebuffer(t.FRAMEBUFFER,l.frameBuffer),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,l.texture);var E=r;r="depth",o(r),q(t.canvas),t.viewport(0,0,l.width,l.height),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST);const F=l.width/l.height;w(F),r=E}{t.bindFramebuffer(t.FRAMEBUFFER,A.frameBuffer),o(r),q(t.canvas),t.viewport(0,0,A.width,A.height),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST);const F=A.width/A.height;w(F)}{t.bindFramebuffer(t.FRAMEBUFFER,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,l.texture),q(t.canvas),t.viewport(0,0,t.canvas.clientWidth,t.canvas.clientHeight),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST);var y={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0],texcoord:[0,0,1,0,0,1,0,1,1,0,1,1]},D=te(t,y);Y(t,"postp_"+r,f),g(t,"postp_"+r,D),t.drawArrays(t.TRIANGLES,0,6)}}S(),setInterval(S,33)}me();
