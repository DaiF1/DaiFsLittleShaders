(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const v of o.addedNodes)v.tagName==="LINK"&&v.rel==="modulepreload"&&r(v)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerpolicy&&(o.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?o.credentials="include":a.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();function q(e){const t=e.clientWidth,n=e.clientHeight,r=e.width!==t||e.height!==n;return r&&(e.width=t,e.height=n),r}function ee(e,t,n){var r=e.createShader(t);e.shaderSource(r,n),e.compileShader(r);var a=e.getShaderParameter(r,e.COMPILE_STATUS);if(a)return r;var o="vertex";t===e.FRAGMENT_SHADER&&(o="fragment"),console.log(n),console.log(o,e.getShaderInfoLog(r)),e.deleteShader(r)}function oe(e,t,n){var r=e.createProgram();e.attachShader(r,t),e.attachShader(r,n),e.linkProgram(r);var a=e.getProgramParameter(r,e.LINK_STATUS);if(a)return r;console.log(e.getProgramInfoLog(r)),e.deleteProgram(r)}var z={},ne={};function ie(e,t){Object.keys(t).forEach(n=>{if(!z[t[n].vertex]){var r=document.querySelector("#"+t[n].vertex).text;z[t[n].vertex]=ee(e,e.VERTEX_SHADER,r)}if(!z[t[n].fragment]){var r=document.querySelector("#"+t[n].fragment).text;z[t[n].fragment]=ee(e,e.FRAGMENT_SHADER,r)}ne[n]=oe(e,z[t[n].vertex],z[t[n].fragment])})}function se(e,t){e.useProgram(K(t))}function K(e){return ne[e]}var k={};function ce(e,t,n){k[t]||(k[t]={}),Object.keys(n).forEach(r=>{k[t][r]||(k[t][r]=e.getAttribLocation(K(t),r)),e.bindBuffer(e.ARRAY_BUFFER,n[r].buffer),e.enableVertexAttribArray(k[t][r]),e.vertexAttribPointer(k[t][r],n[r].numComponents,e.FLOAT,!1,0,0)})}var X={};function V(e,t,n){X[t]||(X[t]={}),se(e,t),Object.keys(n).forEach(r=>{switch(X[t][r]||(X[t][r]=e.getUniformLocation(K(t),r)),n[r].type){case"int1":e.uniform1i(X[t][r],n[r].data);break;case"float1":e.uniform1f(X[t][r],n[r].data);break;case"vec3":e.uniform3fv(X[t][r],n[r].data);break;case"mat4":e.uniformMatrix4fv(X[t][r],!1,n[r].data);break}})}function ue(e,t){let n;if(e.indexOf("coord")>=0?n=2:e.indexOf("color")>=0?n=4:n=3,t%n>0)throw"can not guess numComponents. You should specify it.";return n}function fe(e,t){return e.numComponents||e.size||ue(t,ae(e).length)}function ae(e){return e.length?e:e.data}function ve(e){let t;const n=["position","positions","a_position"];for(const l of n)if(l in e){t=l;break}t=t||Object.keys(e)[0];const r=e[t],a=ae(r).length,o=fe(r,t),v=a/o;if(a%o>0)throw new Error(`numComponents ${o} not correct for length ${a}`);return v}function te(e,t){var n={};return n.numElements=ve(t),n.attribs={},Object.keys(t).forEach(r=>{n.attribs["a_"+r]={},n.attribs["a_"+r].buffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.attribs["a_"+r].buffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(t[r]),e.STATIC_DRAW),n.attribs["a_"+r].numComponents=3}),n.attribs.a_texcoord.numComponents=2,n}function Y(e,t,n){ce(e,t,n.attribs)}var c={identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},perspective:function(e,t,n,r){var a=Math.tan(Math.PI*.5-.5*e),o=1/(n-r);return[a/t,0,0,0,0,a,0,0,0,0,(n+r)*o,-1,0,0,n*r*o*2,0]},orthographic:function(e,t,n,r,a,o){return[2/(t-e),0,0,0,0,2/(r-n),0,0,0,0,2/(a-o),0,(e+t)/(e-t),(n+r)/(n-r),(a+o)/(a-o),1]},translation:function(e,t,n){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,n,1]},xRotation:function(e){var t=Math.cos(e),n=Math.sin(e);return[1,0,0,0,0,t,n,0,0,-n,t,0,0,0,0,1]},yRotation:function(e){var t=Math.cos(e),n=Math.sin(e);return[t,0,-n,0,0,1,0,0,n,0,t,0,0,0,0,1]},zRotation:function(e){var t=Math.cos(e),n=Math.sin(e);return[t,n,0,0,-n,t,0,0,0,0,1,0,0,0,0,1]},scaling:function(e,t,n){return[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1]},multiply:function(e,t){var n=t[0],r=t[0*4+1],a=t[0*4+2],o=t[0*4+3],v=t[1*4+0],l=t[1*4+1],h=t[1*4+2],d=t[1*4+3],s=t[2*4+0],u=t[2*4+1],f=t[2*4+2],i=t[2*4+3],p=t[3*4+0],E=t[3*4+1],T=t[3*4+2],C=t[3*4+3],U=e[0*4+0],_=e[0*4+1],b=e[0*4+2],w=e[0*4+3],y=e[1*4+0],m=e[1*4+1],B=e[1*4+2],D=e[1*4+3],A=e[2*4+0],F=e[2*4+1],I=e[2*4+2],O=e[2*4+3],N=e[3*4+0],L=e[3*4+1],S=e[3*4+2],P=e[3*4+3];return[n*U+r*y+a*A+o*N,n*_+r*m+a*F+o*L,n*b+r*B+a*I+o*S,n*w+r*D+a*O+o*P,v*U+l*y+h*A+d*N,v*_+l*m+h*F+d*L,v*b+l*B+h*I+d*S,v*w+l*D+h*O+d*P,s*U+u*y+f*A+i*N,s*_+u*m+f*F+i*L,s*b+u*B+f*I+i*S,s*w+u*D+f*O+i*P,p*U+E*y+T*A+C*N,p*_+E*m+T*F+C*L,p*b+E*B+T*I+C*S,p*w+E*D+T*O+C*P]},cross:function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]},subtractVectors:function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},normalize:function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return t>1e-5?[e[0]/t,e[1]/t,e[2]/t]:[0,0,0]},lookAt:function(e,t,n){var r=c.normalize(c.subtractVectors(e,t)),a=c.normalize(c.cross(n,r)),o=c.normalize(c.cross(r,a));return[a[0],a[1],a[2],0,o[0],o[1],o[2],0,r[0],r[1],r[2],0,e[0],e[1],e[2],1]},translate:function(e,t,n,r){return c.multiply(e,c.translation(t,n,r))},xRotate:function(e,t){return c.multiply(e,c.xRotation(t))},yRotate:function(e,t){return c.multiply(e,c.yRotation(t))},zRotate:function(e,t){return c.multiply(e,c.zRotation(t))},scale:function(e,t,n,r){return c.multiply(e,c.scaling(t,n,r))},inverse:function(e){var t=e[0],n=e[0*4+1],r=e[0*4+2],a=e[0*4+3],o=e[1*4+0],v=e[1*4+1],l=e[1*4+2],h=e[1*4+3],d=e[2*4+0],s=e[2*4+1],u=e[2*4+2],f=e[2*4+3],i=e[3*4+0],p=e[3*4+1],E=e[3*4+2],T=e[3*4+3],C=u*T,U=E*f,_=l*T,b=E*h,w=l*f,y=u*h,m=r*T,B=E*a,D=r*f,A=u*a,F=r*h,I=l*a,O=d*p,N=i*s,L=o*p,S=i*v,P=o*s,R=d*v,H=t*p,M=i*n,G=t*s,g=d*n,j=t*v,W=o*n,$=C*v+b*s+w*p-(U*v+_*s+y*p),J=U*n+m*s+A*p-(C*n+B*s+D*p),Q=_*n+B*v+F*p-(b*n+m*v+I*p),Z=y*n+D*v+I*s-(w*n+A*v+F*s),x=1/(t*$+o*J+d*Q+i*Z);return[x*$,x*J,x*Q,x*Z,x*(U*o+_*d+y*i-(C*o+b*d+w*i)),x*(C*t+B*d+D*i-(U*t+m*d+A*i)),x*(b*t+m*o+I*i-(_*t+B*o+F*i)),x*(w*t+A*o+F*d-(y*t+D*o+I*d)),x*(O*h+S*f+P*T-(N*h+L*f+R*T)),x*(N*a+H*f+g*T-(O*a+M*f+G*T)),x*(L*a+M*h+j*T-(S*a+H*h+W*T)),x*(R*a+G*h+W*f-(P*a+g*h+j*f)),x*(L*u+R*E+N*l-(P*E+O*l+S*u)),x*(G*E+O*r+M*u-(H*u+g*E+N*r)),x*(H*l+W*E+S*r-(j*E+L*r+M*l)),x*(j*u+P*r+g*l-(G*l+W*u+R*r))]},transpose:function(e){return[e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]]},vectorMultiply:function(e,t){for(var n=[],r=0;r<4;++r){n[r]=0;for(var a=0;a<4;++a)n[r]+=e[a]*t[a*4+r]}return n}};function de(e){const t=[[0,0,0]],n=[[0,0]],r=[[0,0,0]],a=[t,n,r];let o=[[],[],[]];function v(s){s.split("/").forEach((f,i)=>{if(!f)return;const p=parseInt(f),E=p+(p>=0?0:a[i].length);o[i].push(...a[i][E])})}const l={v(s){t.push(s.map(parseFloat))},vn(s){r.push(s.map(parseFloat))},vt(s){n.push(s.map(parseFloat))},f(s){const u=s.length-2;for(let f=0;f<u;++f)v(s[0]),v(s[f+1]),v(s[f+2])}},h=/(\w*)(?: )*(.*)/,d=e.split(`
`);for(let s=0;s<d.length;++s){const u=d[s].trim();if(u===""||u.startsWith("#"))continue;const f=h.exec(u);if(!f)continue;const[,i,p]=f,E=u.split(/\s+/).slice(1),T=l[i];if(!T){console.warn("unhandled keyword:",i,"at line",s+1);continue}T(E,p)}return{position:o[0],texcoord:o[1],normal:o[2]}}function re(e,t,n,r){const a=e.createTexture();e.activeTexture(t),e.bindTexture(e.TEXTURE_2D,a);const o=0,v=e.RGBA,l=0,h=e.RGBA,d=e.UNSIGNED_BYTE,s=null;e.texImage2D(e.TEXTURE_2D,o,v,n,r,l,h,d,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const u=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,u);const f=e.COLOR_ATTACHMENT0;e.framebufferTexture2D(e.FRAMEBUFFER,f,e.TEXTURE_2D,a,o);var i={frameBuffer:u,texture:a,width:n,height:r};return i}function me(e,t,n){var r=e.createTexture();e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,255,255]));var a=new Image;a.src=t,a.addEventListener("load",()=>{e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,a),e.generateMipmap(e.TEXTURE_2D),n()})}async function pe(){var e=document.querySelector("#c"),t=e.getContext("webgl");t||console.log("ERROR: Failed to initialize webgl");var n={depth:{vertex:"vertex-depth",fragment:"fragment-depth"},default:{vertex:"default-vertex",fragment:"default-fragment"},gooch:{vertex:"default-vertex",fragment:"gooch-fragment"},comics:{vertex:"default-vertex",fragment:"comics-fragment"},postp_default:{vertex:"default-vertex-postp",fragment:"default-fragment-postp"},postp_gooch:{vertex:"default-vertex-postp",fragment:"outline-fragment-postp"},postp_comics:{vertex:"default-vertex-postp",fragment:"outline-fragment-postp"}};ie(t,n);var r="default",a=document.querySelector("#shader-select");a.addEventListener("change",()=>{r=a.value,o(r),y()});function o(m){Y(t,m,d),V(t,m,s)}var l=await(await fetch("resources/tree.obj")).text();const h=de(l);var d=te(t,h),s={u_reverseLightDir:{data:c.normalize([.5,.7,-1]),type:"vec3"},u_texture:{data:0,type:"int1"}},u={u_world:{data:c.identity(),type:"mat4"},u_worldViewMatrix:{data:c.identity(),type:"mat4"}},f={u_width:{data:t.canvas.clientWidth,type:"float1"},u_height:{data:t.canvas.clientHeight,type:"float1"},u_depthTexture:{data:1,type:"int1"},u_screenTexture:{data:2,type:"int1"}};Y(t,r,d),V(t,r,s);function i(m){return m*Math.PI/180}var p=[{translation:[0,0,-23],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{translation:[0,0,25],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{translation:[10,0,20],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{translation:[-11,0,-22],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{translation:[23,0,0],rotation:[i(0),i(0),i(0)],scale:[2,2,2]},{translation:[-22,0,-1],rotation:[i(0),i(0),i(0)],scale:[2,2,2]}],E=0,T=0,C=.01,U=!1;addEventListener("keydown",m=>{U=m.ctrlKey}),addEventListener("keyup",m=>{U=m.ctrlKey}),addEventListener("mousemove",m=>{U&&(T+=m.movementX*C,E=Math.max(Math.min(E-m.movementY*C,i(60)),i(-50)),y())}),me(t,"./resources/palette.png",y);var _=re(t,t.TEXTURE1,t.canvas.clientWidth,t.canvas.clientHeight),b=re(t,t.TEXTURE2,t.canvas.clientWidth,t.canvas.clientHeight);function w(m){var B=i(60),D=1,A=2e3,F=c.yRotation(T);F=c.xRotate(F,E),F=c.translate(F,0,10,0);var I=c.inverse(F),O=c.perspective(B,m,D,A),N=c.multiply(O,I);for(let M=0;M<p.length;M++){var L=p[M].translation,S=p[M].rotation,P=p[M].scale,R=c.identity();R=c.translate(R,L[0],L[1],L[2]),R=c.xRotate(R,S[0]),R=c.yRotate(R,S[1]),R=c.zRotate(R,S[2]),R=c.scale(R,P[0],P[1],P[2]);var H=c.multiply(N,R);u.u_worldViewMatrix.data=H,u.u_world.data=R,Y(t,r,d),V(t,r,u),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.drawArrays(t.TRIANGLES,0,d.numElements)}}function y(){{t.bindFramebuffer(t.FRAMEBUFFER,_.frameBuffer),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,_.texture);var m=r;r="depth",o(r),q(t.canvas),t.viewport(0,0,_.width,_.height),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST);const A=_.width/_.height;w(A),r=m}{t.bindFramebuffer(t.FRAMEBUFFER,b.frameBuffer),o(r),q(t.canvas),t.viewport(0,0,b.width,b.height),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST);const A=b.width/b.height;w(A)}{t.bindFramebuffer(t.FRAMEBUFFER,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,_.texture),q(t.canvas),t.viewport(0,0,t.canvas.clientWidth,t.canvas.clientHeight),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.canvas.clientWidth/t.canvas.clientHeight;var B={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0],texcoord:[0,0,1,0,0,1,0,1,1,0,1,1]},D=te(t,B);V(t,"postp_"+r,f),Y(t,"postp_"+r,D),t.drawArrays(t.TRIANGLES,0,6)}}y()}pe();
