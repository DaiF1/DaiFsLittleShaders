(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerpolicy&&(i.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?i.credentials="include":o.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();function $(e){const t=e.clientWidth,n=e.clientHeight,r=e.width!==t||e.height!==n;return r&&(e.width=t,e.height=n),r}function te(e,t,n){var r=e.createShader(t);e.shaderSource(r,n),e.compileShader(r);var o=e.getShaderParameter(r,e.COMPILE_STATUS);if(o)return r;var i="vertex";t===e.FRAGMENT_SHADER&&(i="fragment"),console.log(n),console.log(i,e.getShaderInfoLog(r)),e.deleteShader(r)}function ie(e,t,n){var r=e.createProgram();e.attachShader(r,t),e.attachShader(r,n),e.linkProgram(r);var o=e.getProgramParameter(r,e.LINK_STATUS);if(o)return r;console.log(e.getProgramInfoLog(r)),e.deleteProgram(r)}var q={},ne={};function ue(e,t){Object.keys(t).forEach(n=>{if(!q[t[n].vertex]){var r=document.querySelector("#"+t[n].vertex).text;q[t[n].vertex]=te(e,e.VERTEX_SHADER,r)}if(!q[t[n].fragment]){var r=document.querySelector("#"+t[n].fragment).text;q[t[n].fragment]=te(e,e.FRAGMENT_SHADER,r)}ne[n]=ie(e,q[t[n].vertex],q[t[n].fragment])})}function ce(e,t){e.useProgram(Q(t))}function Q(e){return ne[e]}var Y={};function se(e,t,n){Y[t]||(Y[t]={}),Object.keys(n).forEach(r=>{Y[t][r]||(Y[t][r]=e.getAttribLocation(Q(t),r)),Y[t][r]!==-1&&(e.bindBuffer(e.ARRAY_BUFFER,n[r].buffer),e.enableVertexAttribArray(Y[t][r]),e.vertexAttribPointer(Y[t][r],n[r].numComponents,e.FLOAT,!1,0,0))})}var V={};function K(e,t,n){V[t]||(V[t]={}),ce(e,t),Object.keys(n).forEach(r=>{switch(V[t][r]||(V[t][r]=e.getUniformLocation(Q(t),r)),n[r].type){case"int1":e.uniform1i(V[t][r],n[r].data);break;case"float1":e.uniform1f(V[t][r],n[r].data);break;case"vec3":e.uniform3fv(V[t][r],n[r].data);break;case"mat4":e.uniformMatrix4fv(V[t][r],!1,n[r].data);break}})}function Ee(e,t){let n;if(e.indexOf("coord")>=0?n=2:e.indexOf("color")>=0?n=4:n=3,t%n>0)throw"can not guess numComponents. You should specify it.";return n}function fe(e,t){return e.numComponents||e.size||Ee(t,oe(e).length)}function oe(e){return e.length?e:e.data}function Te(e){let t;const n=["position","positions","a_position"];for(const p of n)if(p in e){t=p;break}t=t||Object.keys(e)[0];const r=e[t],o=oe(r).length,i=fe(r,t),a=o/i;if(o%i>0)throw new Error(`numComponents ${i} not correct for length ${o}`);return a}function J(e,t){var n={};return n.numElements=Te(t),n.attribs={},Object.keys(t).forEach(r=>{n.attribs["a_"+r]={},n.attribs["a_"+r].buffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.attribs["a_"+r].buffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(t[r]),e.STATIC_DRAW),n.attribs["a_"+r].numComponents=3}),n.attribs.a_texcoord.numComponents=2,n}function Z(e,t,n){se(e,t,n.attribs)}var u={identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},perspective:function(e,t,n,r){var o=Math.tan(Math.PI*.5-.5*e),i=1/(n-r);return[o/t,0,0,0,0,o,0,0,0,0,(n+r)*i,-1,0,0,n*r*i*2,0]},orthographic:function(e,t,n,r,o,i){return[2/(t-e),0,0,0,0,2/(r-n),0,0,0,0,2/(o-i),0,(e+t)/(e-t),(n+r)/(n-r),(o+i)/(o-i),1]},translation:function(e,t,n){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,n,1]},xRotation:function(e){var t=Math.cos(e),n=Math.sin(e);return[1,0,0,0,0,t,n,0,0,-n,t,0,0,0,0,1]},yRotation:function(e){var t=Math.cos(e),n=Math.sin(e);return[t,0,-n,0,0,1,0,0,n,0,t,0,0,0,0,1]},zRotation:function(e){var t=Math.cos(e),n=Math.sin(e);return[t,n,0,0,-n,t,0,0,0,0,1,0,0,0,0,1]},scaling:function(e,t,n){return[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1]},multiply:function(e,t){var n=t[0],r=t[0*4+1],o=t[0*4+2],i=t[0*4+3],a=t[1*4+0],p=t[1*4+1],x=t[1*4+2],E=t[1*4+3],c=t[2*4+0],v=t[2*4+1],f=t[2*4+2],_=t[2*4+3],m=t[3*4+0],T=t[3*4+1],h=t[3*4+2],L=t[3*4+3],l=e[0*4+0],b=e[0*4+1],w=e[0*4+2],s=e[0*4+3],D=e[1*4+0],I=e[1*4+1],B=e[1*4+2],N=e[1*4+3],P=e[2*4+0],U=e[2*4+1],S=e[2*4+2],C=e[2*4+3],O=e[3*4+0],G=e[3*4+1],d=e[3*4+2],A=e[3*4+3];return[n*l+r*D+o*P+i*O,n*b+r*I+o*U+i*G,n*w+r*B+o*S+i*d,n*s+r*N+o*C+i*A,a*l+p*D+x*P+E*O,a*b+p*I+x*U+E*G,a*w+p*B+x*S+E*d,a*s+p*N+x*C+E*A,c*l+v*D+f*P+_*O,c*b+v*I+f*U+_*G,c*w+v*B+f*S+_*d,c*s+v*N+f*C+_*A,m*l+T*D+h*P+L*O,m*b+T*I+h*U+L*G,m*w+T*B+h*S+L*d,m*s+T*N+h*C+L*A]},cross:function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]},subtractVectors:function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},normalize:function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return t>1e-5?[e[0]/t,e[1]/t,e[2]/t]:[0,0,0]},lookAt:function(e,t,n){var r=u.normalize(u.subtractVectors(e,t)),o=u.normalize(u.cross(n,r)),i=u.normalize(u.cross(r,o));return[o[0],o[1],o[2],0,i[0],i[1],i[2],0,r[0],r[1],r[2],0,e[0],e[1],e[2],1]},translate:function(e,t,n,r){return u.multiply(e,u.translation(t,n,r))},xRotate:function(e,t){return u.multiply(e,u.xRotation(t))},yRotate:function(e,t){return u.multiply(e,u.yRotation(t))},zRotate:function(e,t){return u.multiply(e,u.zRotation(t))},scale:function(e,t,n,r){return u.multiply(e,u.scaling(t,n,r))},inverse:function(e){var t=e[0],n=e[0*4+1],r=e[0*4+2],o=e[0*4+3],i=e[1*4+0],a=e[1*4+1],p=e[1*4+2],x=e[1*4+3],E=e[2*4+0],c=e[2*4+1],v=e[2*4+2],f=e[2*4+3],_=e[3*4+0],m=e[3*4+1],T=e[3*4+2],h=e[3*4+3],L=v*h,l=T*f,b=p*h,w=T*x,s=p*f,D=v*x,I=r*h,B=T*o,N=r*f,P=v*o,U=r*x,S=p*o,C=E*m,O=_*c,G=i*m,d=_*a,A=i*c,H=E*a,z=t*m,W=_*n,X=t*c,k=E*n,F=t*a,R=i*n,j=L*a+w*c+s*m-(l*a+b*c+D*m),M=l*n+I*c+P*m-(L*n+B*c+N*m),g=b*n+B*a+U*m-(w*n+I*a+S*m),ee=D*n+N*a+S*c-(s*n+P*a+U*c),y=1/(t*j+i*M+E*g+_*ee);return[y*j,y*M,y*g,y*ee,y*(l*i+b*E+D*_-(L*i+w*E+s*_)),y*(L*t+B*E+N*_-(l*t+I*E+P*_)),y*(w*t+I*i+S*_-(b*t+B*i+U*_)),y*(s*t+P*i+U*E-(D*t+N*i+S*E)),y*(C*x+d*f+A*h-(O*x+G*f+H*h)),y*(O*o+z*f+k*h-(C*o+W*f+X*h)),y*(G*o+W*x+F*h-(d*o+z*x+R*h)),y*(H*o+X*x+R*f-(A*o+k*x+F*f)),y*(G*v+H*T+O*p-(A*T+C*p+d*v)),y*(X*T+C*r+W*v-(z*v+k*T+O*r)),y*(z*p+R*T+d*r-(F*T+G*r+W*p)),y*(F*v+A*r+k*p-(X*p+R*v+H*r))]},transpose:function(e){return[e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]]},vectorMultiply:function(e,t){for(var n=[],r=0;r<4;++r){n[r]=0;for(var o=0;o<4;++o)n[r]+=e[o]*t[o*4+r]}return n}};function re(e){const t=[[0,0,0]],n=[[0,0]],r=[[0,0,0]],o=[t,n,r];let i=[[],[],[]];function a(c){c.split("/").forEach((f,_)=>{if(!f)return;const m=parseInt(f),T=m+(m>=0?0:o[_].length);i[_].push(...o[_][T])})}const p={v(c){t.push(c.map(parseFloat))},vn(c){r.push(c.map(parseFloat))},vt(c){n.push(c.map(parseFloat))},f(c){const v=c.length-2;for(let f=0;f<v;++f)a(c[0]),a(c[f+1]),a(c[f+2])}},x=/(\w*)(?: )*(.*)/,E=e.split(`
`);for(let c=0;c<E.length;++c){const v=E[c].trim();if(v===""||v.startsWith("#"))continue;const f=x.exec(v);if(!f)continue;const[,_,m]=f,T=v.split(/\s+/).slice(1),h=p[_];if(!h){console.warn("unhandled keyword:",_,"at line",c+1);continue}h(T,m)}return{position:i[0],texcoord:i[1],normal:i[2]}}function ve(e){const t=e.createTexture(),n=512;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,n,n,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const r=e.createTexture();e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT,n,n,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const o=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,o),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,r,0);var i={frameBuffer:o,depth:r};return i}function _e(e,t,n){const r=e.createTexture();e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,n,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const o=e.createTexture();e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,o),e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT,t,n,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,o,0);var a={frameBuffer:i,texture:r,depth:o,width:t,height:n};return a}function ae(e,t,n,r){var o=e.createTexture();e.activeTexture(n),e.bindTexture(e.TEXTURE_2D,o),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,255,255]));var i=new Image;i.src=t,i.addEventListener("load",()=>{e.bindTexture(e.TEXTURE_2D,o),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),!(i.width&i.width-1)&&!(i.height&i.height-1)?e.generateMipmap(e.TEXTURE_2D):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r)})}async function de(){var e=document.querySelector("#debug-box"),t=document.querySelector("#debug");const n=document.getElementById("lock-status");e.addEventListener("click",()=>{e.checked?t.style.visibility="visible":t.style.visibility="hidden"});var r={};function o(d,A){var H=document.querySelector(d);console.log(H),H.oninput=function(){r[A]=this.value}}var i=document.querySelector("#c"),a=i.getContext("webgl");if(!a){console.log("ERROR: Failed to initialize webgl");return}if(!a.getExtension("WEBGL_depth_texture"))return alert("Unable to load depth texture");var x={default:{vertex:"default-vertex",fragment:"default-fragment"},gooch:{vertex:"default-vertex",fragment:"gooch-fragment"},comics:{vertex:"default-vertex",fragment:"comics-fragment"},drawing:{vertex:"default-vertex",fragment:"drawing-fragment"},postp_default:{vertex:"default-vertex-postp",fragment:"default-fragment-postp"},postp_gooch:{vertex:"default-vertex-postp",fragment:"outline-fragment-postp"},postp_comics:{vertex:"default-vertex-postp",fragment:"outline-fragment-postp"},postp_drawing:{vertex:"default-vertex-postp",fragment:"outline-fragment-postp"}};ue(a,x);var E="default",c=document.querySelector("#shader-select");c.addEventListener("change",()=>{E=c.value,v(E)});function v(d){Z(a,d,T),K(a,d,l)}var f=await fetch("resources/tree.obj"),_=await f.text(),m=re(_),T=J(a,m);f=await fetch("resources/ground.obj"),_=await f.text(),m=re(_);var h=J(a,m),L=u.normalize([.5,.7,-1]),l={u_reverseLightDir:{data:L,type:"vec3"},u_texture:{data:2,type:"int1"},u_shadowTexture:{data:0,type:"int1"},u_textureHash:{data:4,type:"int1"}},b={u_world:{data:u.identity(),type:"mat4"},u_worldViewMatrix:{data:u.identity(),type:"mat4"},u_cameraView:{data:u.identity(),type:"mat4"},u_shadowMatrix:{data:u.identity(),type:"mat4"},u_time:{data:0,type:"float1"}},w={u_width:{data:a.canvas.clientWidth,type:"float1"},u_height:{data:a.canvas.clientHeight,type:"float1"},u_depthTexture:{data:0,type:"int1"},u_screenTexture:{data:1,type:"int1"}};Z(a,E,T),K(a,E,l);function s(d){return d*Math.PI/180}var D=[{bufferInfo:T,translation:[0,0,-23],rotation:[s(0),s(0),s(0)],scale:[2,2,2]},{bufferInfo:T,translation:[0,0,25],rotation:[s(0),s(0),s(0)],scale:[2,2,2]},{bufferInfo:T,translation:[10,0,20],rotation:[s(0),s(0),s(0)],scale:[2,2,2]},{bufferInfo:T,translation:[-11,0,-22],rotation:[s(0),s(0),s(0)],scale:[2,2,2]},{bufferInfo:T,translation:[23,0,0],rotation:[s(0),s(0),s(0)],scale:[2,2,2]},{bufferInfo:T,translation:[-22,0,-1],rotation:[s(0),s(0),s(0)],scale:[2,2,2]},{bufferInfo:h,translation:[0,-4,0],rotation:[s(0),s(0),s(0)],scale:[3,1,3]}];r.cameraX=0,r.cameraY=10,r.cameraZ=0;var I=0,B=0,N=.01,P=!0;o("#camera-x","cameraX"),o("#camera-y","cameraY"),o("#camera-z","cameraZ"),addEventListener("keydown",d=>{d.ctrlKey&&(P=!P,n.innerText=`(currently ${P?"unlocked":"locked"})`)}),addEventListener("mousemove",d=>{P&&(B-=d.movementX*N,I=Math.max(Math.min(I-d.movementY*N,s(60)),s(-50)))}),ae(a,"./resources/palette.png",a.TEXTURE2,a.LINEAR),ae(a,"./resources/hash.png",a.TEXTURE4,a.NEAREST);var U=_e(a,a.canvas.clientWidth,a.canvas.clientHeight),S=ve(a);function C(d,A,H){var z=u.inverse(A),W=u.multiply(d,z);for(let M=0;M<D.length;M++){var X=D[M].translation,k=D[M].rotation,F=D[M].scale,R=u.identity();R=u.translate(R,X[0],X[1],X[2]),R=u.xRotate(R,k[0]),R=u.yRotate(R,k[1]),R=u.zRotate(R,k[2]),R=u.scale(R,F[0],F[1],F[2]);var j=u.multiply(W,R);R=u.inverse(R),R=u.transpose(R),b.u_worldViewMatrix.data=j,b.u_world.data=R,b.u_cameraView.data=A,b.u_shadowMatrix.data=H,b.u_time.data=O,Z(a,E,D[M].bufferInfo),K(a,E,b),a.enable(a.CULL_FACE),a.enable(a.DEPTH_TEST),a.drawArrays(a.TRIANGLES,0,D[M].bufferInfo.numElements)}}var O=0;function G(){O+=.03;{a.bindFramebuffer(a.FRAMEBUFFER,S.frameBuffer),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,S.depth),v(E),$(a.canvas),a.viewport(0,0,512,512),a.clearColor(1,1,1,1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.enable(a.CULL_FACE),a.enable(a.DEPTH_TEST);var d=u.lookAt([0,5,0],L,[0,1,0]),A=u.perspective(s(120),a.canvas.clientWidth/a.canvas.clientHeight,.1,200);C(A,d,u.identity()),a.bindFramebuffer(a.FRAMEBUFFER,U.frameBuffer),v(E),$(a.canvas),a.viewport(0,0,U.width,U.height),a.clearColor(1,1,1,1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.enable(a.CULL_FACE),a.enable(a.DEPTH_TEST);var H=s(60),z=1,W=200;const M=U.width/U.height;var X=u.yRotation(B);X=u.xRotate(X,I),X=u.translate(X,r.cameraX,r.cameraY,r.cameraZ);var k=u.perspective(H,M,z,W),F=u.translation(.5,.5,.5);F=u.scale(F,.5,.5,.5),F=u.multiply(F,A),F=u.multiply(F,u.inverse(d)),C(k,X,F)}{a.bindFramebuffer(a.FRAMEBUFFER,null),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,U.depth),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,U.texture),$(a.canvas),a.viewport(0,0,a.canvas.clientWidth,a.canvas.clientHeight),a.clearColor(1,1,1,1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.enable(a.CULL_FACE),a.enable(a.DEPTH_TEST);var R={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0],texcoord:[0,0,1,0,0,1,0,1,1,0,1,1]},j=J(a,R);K(a,"postp_"+E,w),Z(a,"postp_"+E,j),a.drawArrays(a.TRIANGLES,0,6)}}G(),setInterval(G,33)}de();
